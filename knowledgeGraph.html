<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å›¾è°± - çš–åŒ—å†›äº‹ç¯å¢ƒæˆå› çŸ¥è¯†å›¾è°±å¹³å°</title>
    <meta name="description" content="äº¤äº’å¼çŸ¥è¯†å›¾è°±å¯è§†åŒ–ï¼Œæ¢ç´¢å†å²äº‹ä»¶ã€äººç‰©ã€åœ°ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œæ”¯æŒèŠ‚ç‚¹ç­›é€‰å’Œå…³ç³»æ¢ç´¢">
    <meta name="keywords" content="çŸ¥è¯†å›¾è°±,å¯è§†åŒ–,å…³è”å…³ç³»,èŠ‚ç‚¹æ¢ç´¢">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:8080/knowledgeGraph.html">
    <meta property="og:title" content="çŸ¥è¯†å›¾è°± - çš–åŒ—å†›äº‹ç¯å¢ƒæˆå› çŸ¥è¯†å›¾è°±å¹³å°">
    <meta property="og:description" content="äº¤äº’å¼çŸ¥è¯†å›¾è°±å¯è§†åŒ–ï¼Œæ¢ç´¢å†å²äº‹ä»¶ã€äººç‰©ã€åœ°ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="çŸ¥è¯†å›¾è°± - çš–åŒ—å†›äº‹ç¯å¢ƒæˆå› çŸ¥è¯†å›¾è°±å¹³å°">
    <meta property="twitter:description" content="äº¤äº’å¼çŸ¥è¯†å›¾è°±å¯è§†åŒ–ï¼Œæ¢ç´¢å†å²äº‹ä»¶ã€äººç‰©ã€åœ°ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="page-styles.css">
    <link rel="stylesheet" href="css/knowledge-graph-styles.css">
    <link rel="stylesheet" href="css/loading-indicator.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet" onerror="this.onerror=null; this.href='';">
    <style>
        @font-face {
            font-family: 'Noto Serif SC Fallback';
            src: local('SimSun'), local('å®‹ä½“');
        }
        @font-face {
            font-family: 'Noto Sans SC Fallback';
            src: local('Microsoft YaHei'), local('å¾®è½¯é›…é»‘');
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="logo-icon">ğŸ—ºï¸</span>
                <span class="logo-text">çš–åŒ—å†›äº‹ç¯å¢ƒæˆå› <br>çŸ¥è¯†å›¾è°±å¹³å°</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                <li><a href="overview.html" class="nav-link">æ•°æ®æ¦‚è§ˆ</a></li>
                <li><a href="events.html" class="nav-link">å†å²äº‹ä»¶</a></li>
                <li><a href="map-interactive.html" class="nav-link">åœ°ç†åœ°å›¾</a></li>
                <li><a href="map-canvas.html" class="nav-link">äº‹ä»¶åˆ†å¸ƒ</a></li>
                <li><a href="persons.html" class="nav-link">äººç‰©åç‰‡</a></li>
                <li><a href="knowledgeGraph.html" class="nav-link active">çŸ¥è¯†å›¾è°±</a></li>
                <li><a href="http://localhost:3000" target="_blank" class="nav-link">å®é™…ç³»ç»Ÿ</a></li>
            </ul>
            <div class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- é¡µé¢å†…å®¹ -->
    <div class="page-container">
        <div class="page-header page-header-knowledge">
            <div class="container">
                <h1 class="page-title">çŸ¥è¯†å›¾è°±</h1>
                <p class="page-subtitle">çš–åŒ—å†›äº‹ç¯å¢ƒæˆå› çŸ¥è¯†å›¾è°±å¯è§†åŒ–</p>
            </div>
        </div>

        <div class="page-content">
            <div class="container">
                <!-- æœç´¢å’Œæ§åˆ¶ -->
                <div class="graph-controls">
                    <div class="search-section">
                        <input type="text" placeholder="è¯·è¾“å…¥äº‹ä»¶/äººç‰©/åœ°ç‚¹æœç´¢..." class="graph-search">
                        <button class="search-btn">æœç´¢</button>
                        <img src="https://feiyi.inhct.cn/h5/h5images/icon_positonBack.png" id="back" alt="è¿”å›" class="back-btn-img" style="margin-left: 10px;">
                    </div>
                    <div class="graph-options">
                        <button id="kg-extend-toggle" class="search-btn" style="padding: 6px 16px;">
                            å±•å¼€å»¶å±•å…³ç³»
                        </button>
                        <span>
                            ï¼ˆæ‰“å¼€åï¼Œç‚¹å‡»äº‹ä»¶èŠ‚ç‚¹å°†å°½é‡æ˜¾ç¤ºå…¶ç›¸å…³äººç‰©ã€åœ°ç‚¹åŠæ›´å¤šå…³ç³»ï¼‰
                        </span>
                    </div>
                </div>

                <!-- å›¾è°±å±•ç¤ºåŒºåŸŸ -->
                <div class="graph-container" style="position: relative;">
                    <div id="cy" class="graph-placeholder" style="height:600px; width:100%;"></div>
                    
                    <!-- å›¾ä¾‹ï¼ˆcanvas-legend æ ·å¼ï¼‰- ç»å¯¹å®šä½åœ¨å·¦ä¸‹è§’ -->
                    <div class="canvas-legend" style="position: absolute; bottom: 30px; left: 30px; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); max-width: 280px; z-index: 1000;">
                        <div class="legend-item" style="display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; color: #374151;">
                            <div class="legend-color" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; background: #ef4444;"></div>
                            <span>äº‹ä»¶èŠ‚ç‚¹</span>
                        </div>
                        <div class="legend-item" style="display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; color: #374151;">
                            <div class="legend-color" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; background: #f59e0b;"></div>
                            <span>äººç‰©èŠ‚ç‚¹</span>
                        </div>
                        <div class="legend-item" style="display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; color: #374151;">
                            <div class="legend-color" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; background: #10b981;"></div>
                            <span>åœ°ç‚¹èŠ‚ç‚¹</span>
                        </div>
                        <div class="legend-item" style="display: flex; align-items: center; margin-bottom: 0; font-size: 13px; color: #374151;">
                            <div class="legend-color" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; background: #3b82f6;"></div>
                            <span>æ—¶é—´èŠ‚ç‚¹</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="page-footer">
        <div class="container">
            <div class="footer-nav">
                <a href="index.html">é¦–é¡µ</a>
                <span>ä¸¨</span>
                <a href="overview.html">æ•°æ®æ¦‚è§ˆ</a>
                <span>ä¸¨</span>
                <a href="events.html">å†å²äº‹ä»¶</a>
                <span>ä¸¨</span>
                <a href="map.html">åœ°ç†åœ°å›¾</a>
                <span>ä¸¨</span>
                <a href="persons.html">äººç‰©åç‰‡</a>
            </div>
            <p class="footer-copyright">Â©2025 çš–åŒ—å†›äº‹ç¯å¢ƒæˆå› çŸ¥è¯†å›¾è°±å¹³å°</p>
        </div>
    </footer>

    <!-- ä½¿ç”¨ vis.js (vis-network) ä»¥å®Œå…¨åŒ¹é… Neo4j Browser çš„æ¸²æŸ“æ•ˆæœ -->
    <script type="text/javascript" src="https://unpkg.com/vis-network@latest/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@latest/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    
    <!-- çŸ¥è¯†å›¾è°±æ¨¡å—åŒ–ä»£ç ï¼ˆæŒ‰ä¾èµ–é¡ºåºåŠ è½½ï¼‰ -->
    <script src="js/kg-config.js"></script>
    <script src="js/kg-utils.js"></script>
    <script src="js/kg-cache.js"></script>
    <script src="js/kg-renderer-vis.js"></script>
    <script src="js/kg-renderer.js"></script>
    <script src="js/kg-views.js"></script>
    <!-- çº¿ç´¢å»¶å±•åŠŸèƒ½ -->
    <script src="js/kg-trail-extend.js"></script>
    <script src="js/kg-trail-integration.js"></script>
    <!-- çº¿ç´¢å»¶å±•è°ƒè¯•å·¥å…· -->
    <script src="js/kg-trail-debug.js"></script>
    
    <!-- ä¸»è„šæœ¬ -->
    <script src="script.js"></script>
    <script src="page-scripts.js"></script>
    <script src="data-loader.js"></script>
    <script>
        // è¿”å›æŒ‰é’®åŠŸèƒ½ + å»¶å±•å…³ç³»å¼€å…³
        document.addEventListener('DOMContentLoaded', function() {
            const backBtn = document.getElementById('back');
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    if (window.KGViews) {
                        window.KGViews.init(); // é‡ç½®è§†å›¾æ ˆ
                        window.KGViews.showInitialView(); // æ˜¾ç¤ºåˆå§‹è§†å›¾
                    }
                });
            }
            
            // äº‹ä»¶ç±»å‹å’Œåœ°åŒºç­›é€‰åŠŸèƒ½ï¼ˆå¯ä»¥åç»­å®ç°ï¼‰
            const eventTypeFilter = document.getElementById('eventTypeFilter');
            const regionFilter = document.getElementById('regionFilter');
            
            if (eventTypeFilter) {
                eventTypeFilter.addEventListener('change', function() {
                    console.log('äº‹ä»¶ç±»å‹ç­›é€‰:', this.value);
                    // å¯ä»¥åœ¨è¿™é‡Œå®ç°ç­›é€‰é€»è¾‘
                });
            }
            
            if (regionFilter) {
                regionFilter.addEventListener('change', function() {
                    console.log('åœ°åŒºç­›é€‰:', this.value);
                    // å¯ä»¥åœ¨è¿™é‡Œå®ç°ç­›é€‰é€»è¾‘
                });
            }

            // æœç´¢åŠŸèƒ½
            const searchInput = document.querySelector('.graph-search');
            const searchBtn = document.querySelector('.graph-controls .search-btn');
            
            function performSearch() {
                if (!searchInput) return;
                
                const keyword = searchInput.value.trim();
                if (!keyword) {
                    // å¦‚æœæœç´¢å…³é”®è¯ä¸ºç©ºï¼Œè¿”å›åˆå§‹è§†å›¾
                    if (window.KGViews) {
                        window.KGViews.showInitialView();
                    }
                    return;
                }
                
                console.log('æœç´¢å…³é”®è¯:', keyword);
                
                // è·å–ç¼“å­˜
                if (!window.KGCache || !window.KGCache.cache) {
                    console.warn('çŸ¥è¯†å›¾è°±ç¼“å­˜æœªåŠ è½½');
                    return;
                }
                
                const cache = window.KGCache.cache;
                const keywordLower = keyword.toLowerCase();
                
                // æœç´¢åŒ¹é…çš„èŠ‚ç‚¹
                const matchedNodes = [];
                const matchedNodeIds = new Set();
                
                cache.allNodes.forEach(node => {
                    const label = (node.data.label || node.data.name || node.data.åç§° || '').toLowerCase();
                    const name = (node.data.name || node.data.å§“å || node.data.åç§° || '').toLowerCase();
                    
                    if (label.includes(keywordLower) || name.includes(keywordLower)) {
                        matchedNodes.push(node);
                        matchedNodeIds.add(node.data.id);
                    }
                });
                
                console.log(`æ‰¾åˆ° ${matchedNodes.length} ä¸ªåŒ¹é…èŠ‚ç‚¹`);
                
                if (matchedNodes.length === 0) {
                    alert(`æœªæ‰¾åˆ°ä¸"${keyword}"ç›¸å…³çš„èŠ‚ç‚¹`);
                    return;
                }
                
                // æ‰¾åˆ°åŒ¹é…èŠ‚ç‚¹çš„æ‰€æœ‰å…³ç³»ï¼ˆå»é‡ï¼‰
                const matchedEdgesMap = new Map(); // ä½¿ç”¨ Map æ¥å»é‡ï¼Œä»¥ edge.data.id æˆ–ç”Ÿæˆçš„IDä½œä¸ºkey
                cache.allEdges.forEach(edge => {
                    const hasSource = matchedNodeIds.has(edge.data.source);
                    const hasTarget = matchedNodeIds.has(edge.data.target);
                    
                    if (hasSource || hasTarget) {
                        // ä½¿ç”¨ edge.data.id å¦‚æœå­˜åœ¨ï¼Œå¦åˆ™ç”Ÿæˆå”¯ä¸€IDï¼ˆä¸æ¸²æŸ“å™¨ä¿æŒä¸€è‡´ï¼‰
                        // æ¸²æŸ“å™¨ä½¿ç”¨æ ¼å¼: source-label-targetï¼Œè¿™é‡Œä¿æŒä¸€è‡´
                        const edgeId = edge.data.id || `${edge.data.source}-${edge.data.label || ''}-${edge.data.target}`;
                        // åªæœ‰å½“è¿™æ¡è¾¹è¿˜æ²¡æœ‰è¢«æ·»åŠ æ—¶æ‰æ·»åŠ 
                        if (!matchedEdgesMap.has(edgeId)) {
                            matchedEdgesMap.set(edgeId, edge);
                        }
                    }
                });
                
                const matchedEdges = Array.from(matchedEdgesMap.values());
                
                // è·å–æ‰€æœ‰ç›¸å…³çš„èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å…³ç³»çš„å¦ä¸€ç«¯ï¼‰
                const relatedNodeIds = new Set(matchedNodeIds);
                matchedEdges.forEach(edge => {
                    if (matchedNodeIds.has(edge.data.source)) {
                        relatedNodeIds.add(edge.data.target);
                    }
                    if (matchedNodeIds.has(edge.data.target)) {
                        relatedNodeIds.add(edge.data.source);
                    }
                });
                
                // æ„å»ºæœç´¢ç»“æœè§†å›¾ï¼ˆèŠ‚ç‚¹å»é‡ï¼‰
                const resultNodeIds = new Set();
                const resultNodes = [];
                cache.allNodes.forEach(node => {
                    if (relatedNodeIds.has(node.data.id) && !resultNodeIds.has(node.data.id)) {
                        resultNodeIds.add(node.data.id);
                        resultNodes.push(node);
                    }
                });
                
                const resultEdges = matchedEdges;
                
                console.log(`æœç´¢ç»“æœ: ${resultNodes.length} ä¸ªèŠ‚ç‚¹, ${resultEdges.length} æ¡å…³ç³»`);
                
                // æ¸²æŸ“æœç´¢ç»“æœ
                if (window.KGRenderer) {
                    window.KGRenderer.render(resultNodes, resultEdges);
                }
            }
            
            if (searchBtn && searchInput) {
                searchBtn.addEventListener('click', performSearch);
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
            
            // å»¶å±•å…³ç³»å¼€å…³æŒ‰é’®ï¼ˆè®¾ç½®å…¨å±€æ ‡å¿—ä½ï¼Œå¹¶ç«‹å³åˆ·æ–°å½“å‰è§†å›¾ï¼‰
            const extendToggle = document.getElementById('kg-extend-toggle');
            if (extendToggle) {
                window.__kgExtendRelations = false;
                extendToggle.addEventListener('click', function () {
                    window.__kgExtendRelations = !window.__kgExtendRelations;
                    if (window.__kgExtendRelations) {
                        extendToggle.textContent = 'å…³é—­å»¶å±•å…³ç³»';
                        extendToggle.style.backgroundColor = '#2563eb';
                        extendToggle.style.color = '#ffffff';
                    } else {
                        extendToggle.textContent = 'å±•å¼€å»¶å±•å…³ç³»';
                        extendToggle.style.backgroundColor = '';
                        extendToggle.style.color = '';
                    }
                    console.log('å»¶å±•å…³ç³»æ¨¡å¼:', window.__kgExtendRelations);
                    
                    // ç«‹å³åˆ·æ–°å½“å‰è§†å›¾ï¼Œæ˜¾ç¤º/éšè—å»¶å±•å…³ç³»
                    const views = window.KGViews;
                    if (views) {
                        const currentView = views.getCurrentView();
                        if (currentView) {
                            // æ ¹æ®å½“å‰è§†å›¾ç±»å‹é‡æ–°æ¸²æŸ“
                            if (currentView.type === 'event' && currentView.centerId) {
                                views.showEventView(currentView.centerId);
                            } else if (currentView.type === 'eventSet' && currentView.centerId) {
                                views.showEventSetView(currentView.centerId);
                            } else if ((currentView.type === 'person' || currentView.type === 'location') && currentView.centerId) {
                                views.showPersonLocationView(currentView.centerId);
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
